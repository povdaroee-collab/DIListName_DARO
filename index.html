<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>បញ្ជីឈ្មោះបុគ្គលិក (Staff List)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background-color: #f8fafc; /* A lighter, cleaner background */
        }
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #a8a8a8;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #888;
        }
        .card-enter {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }
        .card-enter-active {
            opacity: 1;
            transform: translateY(0);
        }
        .pagination-btn {
            @apply flex items-center justify-center px-3 h-8 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-lg hover:bg-gray-100 hover:text-gray-700 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-400 dark:hover:bg-slate-700 dark:hover:text-white;
        }
        .pagination-btn.active {
             @apply z-10 text-blue-600 border-blue-300 bg-blue-50 hover:bg-blue-100 hover:text-blue-700 dark:border-slate-500 dark:bg-slate-700 dark:text-white;
        }
        .pagination-btn.disabled {
            @apply opacity-50 cursor-not-allowed;
        }

    </style>
</head>
<body class="dark:bg-slate-900 text-slate-800 dark:text-slate-200 min-h-screen">

    <div class="container mx-auto p-4 md:p-6">
        <!-- Header -->
        <header class="text-center mb-6 md:mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900 dark:text-white flex items-center justify-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-500"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                <span>បញ្ជីឈ្មោះបុគ្គលិក</span>
            </h1>
            <h2 class="text-xl md:text-2xl font-medium text-slate-700 dark:text-slate-300 mt-2">ឧស្សាហកម្មឌីជីថល</h2>
        </header>

        <!-- Filter and Search Controls -->
        <div class="bg-white/80 dark:bg-slate-800/80 backdrop-blur-sm p-4 rounded-xl shadow-lg mb-6 sticky top-4 z-10 border dark:border-slate-700">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Search Input -->
                <div class="col-span-1 md:col-span-2 lg:col-span-1">
                    <label for="searchInput" class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1">ស្វែងរក</label>
                    <input type="text" id="searchInput" placeholder="ឈ្មោះ, អត្តលេខ, ក្រុម, ថ្នាក់..." class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                </div>
                <!-- Group Filter -->
                <div>
                    <label for="groupFilter" class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1">ក្រុម</label>
                    <select id="groupFilter" class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        <option value="">គ្រប់ក្រុម</option>
                    </select>
                </div>
                <!-- Class Filter -->
                <div>
                    <label for="classFilter" class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1">ថ្នាក់</label>
                    <select id="classFilter" class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        <option value="">គ្រប់ថ្នាក់</option>
                    </select>
                </div>
                <!-- Section Filter -->
                <div>
                    <label for="sectionFilter" class="block text-sm font-medium text-slate-700 dark:text-slate-200 mb-1">ផ្នែកការងារ</label>
                    <select id="sectionFilter" class="w-full px-3 py-2 border border-slate-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                        <option value="">គ្រប់ផ្នែក</option>
                    </select>
                </div>
            </div>
             <div class="flex flex-wrap gap-4 justify-between items-center mt-4">
                <div id="staffCount" class="text-sm text-slate-600 dark:text-slate-400"></div>
                <div class="flex items-center gap-3">
                    <button id="refreshButton" title="ផ្ទុកទិន្នន័យឡើងវិញ" class="group p-2 text-sm bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform group-hover:rotate-180"><polyline points="23 4 23 10 17 10"></polyline><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg>
                    </button>
                    <button id="resetButton" title="សម្អាតតម្រង" class="group p-2 text-sm bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition dark:bg-slate-600 dark:text-slate-200 dark:hover:bg-slate-500">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="transition-transform group-hover:rotate-[-15deg]"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"/><path d="M22 21H7"/><path d="m5 12 5 5"/></svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Loading Spinner -->
        <div id="loading" class="text-center py-10">
            <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-2 text-slate-600 dark:text-slate-300">កំពុងទាញទិន្នន័យ...</p>
        </div>

        <!-- Staff List Container -->
        <div id="staffList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5">
            <!-- Staff cards will be inserted here by JavaScript -->
        </div>

        <!-- Pagination Controls -->
        <div id="paginationControls" class="flex justify-center items-center space-x-1 sm:space-x-2 mt-8">
            <!-- Pagination buttons will be injected here -->
        </div>

        <!-- No Results Message -->
        <div id="noResults" class="hidden text-center py-10">
            <p class="text-slate-600 dark:text-slate-300 text-lg">មិនមានទិន្នន័យត្រូវគ្នានឹងការស្វែងរកទេ។</p>
        </div>
    </div>

    <!-- Footer -->
    <footer class="text-center py-4 mt-8">
        <p class="text-sm text-slate-500 dark:text-slate-400">
            អ្នកអភិវឌ្ឍកម្មវិធី IT SUPPORT | <a href="https://darotrb0-bit.github.io/MMKITSUPPORTDI/" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">MMKITSUPPORTDI</a>
        </p>
    </footer>

    <script>
        // --- CONFIGURATION ---
        const SHEET_ID = '1eRyPoifzyvB4oBmruNyXcoKMKPRqjk6xDD6-bPNW6pc';
        const SHEET_NAME = 'DIList';
        const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${SHEET_NAME}`;

        // --- DOM ELEMENTS ---
        const searchInput = document.getElementById('searchInput');
        const groupFilter = document.getElementById('groupFilter');
        const classFilter = document.getElementById('classFilter');
        const sectionFilter = document.getElementById('sectionFilter');
        const staffListContainer = document.getElementById('staffList');
        const loadingIndicator = document.getElementById('loading');
        const noResultsMessage = document.getElementById('noResults');
        const staffCount = document.getElementById('staffCount');
        const resetButton = document.getElementById('resetButton');
        const refreshButton = document.getElementById('refreshButton');
        const paginationControls = document.getElementById('paginationControls');

        let allStaff = [];
        let filteredStaff = [];
        let currentPage = 1;
        let itemsPerPage = 20;

        // --- DATA FETCHING AND PARSING ---
        async function fetchData() {
            loadingIndicator.style.display = 'block';
            staffListContainer.innerHTML = '';
            paginationControls.innerHTML = '';
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const csvText = await response.text();
                const rows = csvText.split('\n').slice(1);

                allStaff = rows.map(row => {
                    const columns = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                    const cleanCols = columns.map(col => col.trim().replace(/^"|"$/g, ''));

                    return {
                        id: cleanCols[4] || '',      // Column E
                        group: cleanCols[6] || '',   // Column G
                        name: cleanCols[11] || '',   // Column L
                        gender: cleanCols[13] || '', // Column N
                        class: cleanCols[17] || '',  // Column R
                        section: cleanCols[18] || '',// Column S
                        photoUrl: cleanCols[26] || ''// Column AA
                    };
                }).filter(staff => staff.id && staff.name);

                filteredStaff = [...allStaff];
                populateFilters();
                updateItemsPerPage();
                displayPage(1);

            } catch (error) {
                console.error('Error fetching or parsing data:', error);
                staffListContainer.innerHTML = '<p class="text-center text-red-500">មានបញ្ហាក្នុងការទាញទិន្នន័យ។ សូមព្យាយាមម្តងទៀត។</p>';
            } finally {
                loadingIndicator.style.display = 'none';
            }
        }
        
        // --- PAGINATION & DISPLAY LOGIC ---
        function updateItemsPerPage() {
            if (window.innerWidth < 640) { // sm breakpoint
                itemsPerPage = 10;
            } else {
                itemsPerPage = 20;
            }
        }
        
        function displayPage(page) {
            currentPage = page;
            staffListContainer.innerHTML = '';
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedItems = filteredStaff.slice(startIndex, endIndex);

            noResultsMessage.style.display = filteredStaff.length === 0 ? 'block' : 'none';
            staffCount.textContent = `លទ្ធផល៖ ${filteredStaff.length} នាក់`;

            paginatedItems.forEach((staff, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white dark:bg-slate-800 rounded-xl shadow-md hover:shadow-xl hover:scale-[1.03] p-4 transition-all duration-300 card-enter border border-slate-200 dark:border-slate-700';
                card.innerHTML = `
                    <div class="flex items-center space-x-4">
                        <div class="w-16 h-16 rounded-full flex-shrink-0 bg-slate-200 dark:bg-slate-700 border-4 border-slate-200 dark:border-slate-600 overflow-hidden">
                            <img 
                                src="${staff.photoUrl || `https://placehold.co/100x100/EBF4FF/333333?text=${staff.name.charAt(0)}`}" 
                                onerror="this.onerror=null; this.src='https://placehold.co/100x100/EBF4FF/333333?text=${staff.name.charAt(0)}'"
                                alt="រូបថតរបស់ ${staff.name}" 
                                class="w-full h-full object-cover"
                                loading="lazy"
                                decoding="async"
                            >
                        </div>
                        <div class="flex-1">
                            <h3 class="text-md sm:text-lg font-bold text-slate-900 dark:text-white">${staff.name}</h3>
                            <p class="text-sm text-slate-500 dark:text-slate-400">អត្តលេខ: ${staff.id}</p>
                            <div class="mt-2 flex flex-wrap gap-x-2 gap-y-1">
                                ${staff.group ? `<span class="px-2 py-0.5 text-xs font-semibold text-green-800 bg-green-100 dark:bg-green-900 dark:text-green-200 rounded-full">${staff.group}</span>` : ''}
                                ${staff.class ? `<span class="px-2 py-0.5 text-xs font-semibold text-indigo-800 bg-indigo-100 dark:bg-indigo-900 dark:text-indigo-200 rounded-full">${staff.class}</span>` : ''}
                                ${staff.section ? `<span class="px-2 py-0.5 text-xs font-semibold text-purple-800 bg-purple-100 dark:bg-purple-900 dark:text-purple-200 rounded-full">${staff.section}</span>` : ''}
                            </div>
                        </div>
                    </div>
                `;
                staffListContainer.appendChild(card);
                setTimeout(() => card.classList.add('card-enter-active'), index * 25);
            });
            
            setupPagination();
        }

        function setupPagination() {
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(filteredStaff.length / itemsPerPage);

            if (totalPages <= 1) return;

            // Previous Button
            const prevButton = document.createElement('button');
            prevButton.innerHTML = `&laquo;`;
            prevButton.className = 'pagination-btn';
            if (currentPage === 1) prevButton.classList.add('disabled');
            prevButton.addEventListener('click', () => {
                if(currentPage > 1) displayPage(currentPage - 1);
            });
            paginationControls.appendChild(prevButton);

            // Page Buttons
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = 'pagination-btn';
                if (i === currentPage) pageButton.classList.add('active');
                pageButton.addEventListener('click', () => displayPage(i));
                paginationControls.appendChild(pageButton);
            }

            // Next Button
            const nextButton = document.createElement('button');
            nextButton.innerHTML = `&raquo;`;
            nextButton.className = 'pagination-btn';
            if (currentPage === totalPages) nextButton.classList.add('disabled');
            nextButton.addEventListener('click', () => {
                if(currentPage < totalPages) displayPage(currentPage + 1);
            });
            paginationControls.appendChild(nextButton);
        }

        // --- FILTERING LOGIC ---
        function populateFilters() {
            const groups = [...new Set(allStaff.map(s => s.group).filter(Boolean))].sort();
            const classes = [...new Set(allStaff.map(s => s.class).filter(Boolean))].sort();
            const sections = [...new Set(allStaff.map(s => s.section).filter(Boolean))].sort();

            populateSelect(groupFilter, groups);
            populateSelect(classFilter, classes);
            populateSelect(sectionFilter, sections);
        }

        function populateSelect(selectElement, options) {
            // Clear previous options except the first one
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }
            options.forEach(option => {
                const opt = document.createElement('option');
                opt.value = option;
                opt.textContent = option;
                selectElement.appendChild(opt);
            });
        }

        function applyFilters() {
            const searchTerm = searchInput.value.toLowerCase().trim();
            const selectedGroup = groupFilter.value;
            const selectedClass = classFilter.value;
            const selectedSection = sectionFilter.value;

            filteredStaff = allStaff.filter(staff => {
                const matchesSearch = staff.name.toLowerCase().includes(searchTerm) || 
                                      staff.id.toLowerCase().includes(searchTerm) ||
                                      staff.group.toLowerCase().includes(searchTerm) ||
                                      staff.class.toLowerCase().includes(searchTerm) ||
                                      staff.section.toLowerCase().includes(searchTerm);
                const matchesGroup = !selectedGroup || staff.group === selectedGroup;
                const matchesClass = !selectedClass || staff.class === selectedClass;
                const matchesSection = !selectedSection || staff.section === selectedSection;
                return matchesSearch && matchesGroup && matchesClass && matchesSection;
            });

            displayPage(1); // Reset to first page
        }

        function resetAllFilters() {
            searchInput.value = '';
            groupFilter.value = '';
            classFilter.value = '';
            sectionFilter.value = '';
            filteredStaff = [...allStaff];
            displayPage(1);
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', fetchData);
        searchInput.addEventListener('input', applyFilters);
        groupFilter.addEventListener('change', applyFilters);
        classFilter.addEventListener('change', applyFilters);
        sectionFilter.addEventListener('change', applyFilters);
        resetButton.addEventListener('click', resetAllFilters);
        refreshButton.addEventListener('click', () => {
            location.reload();
        });
        window.addEventListener('resize', () => {
            updateItemsPerPage();
            // Re-render the current view with the new itemsPerPage value
            displayPage(currentPage); 
        });

    </script>
</body>
</html>

